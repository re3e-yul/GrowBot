#! /bin/bash

if [[ $# -eq 0 ]]
then
    echo "Usage: GrowBot6.sh -fF/-gG [Minutes period]"
    exit 0
fi
for var in "$@"
do
       case "$var" in
                -[fF]) Mode="Flowering"
                ;;
                -[gG]) Mode="Vegetative"
                ;;
                -[vV]) Mode="Vegetative"
                ;;
                [1-59]*) period=$var
                ;;
                -FF) ForceFlood="1"
        esac
case "$Mode" in
                Flowering)
                LightOn="08"
                LightOff="20"
                ;;
                Vegetative)
                LightOn="06"
                LightOff="22"
                ;;
esac
done
Level="0"
date=$(date +%T)
LastFlood=$(echo "SELECT LastFlood FROM farmSched ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm)
NextFlood=$(echo "SELECT NextFlood FROM farmSched ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm)




Lights()
        {
        #######################
        #                     #
        #  Turn on the lights #
        #                     #
        #######################
        LightOn=$1
        LightOff=$2
	period=$3
        if [ $(/bin/date +%H) -ge $LightOn ] && [ $(/bin/date +%H) -lt $LightOff ]
        then
#                echo "day"
                if [ $(gpio -g read 18) -eq 0 ]
                then
                        gpio -g write 18 1
                fi
		Water $period
        else
#                echo "night"
                if [ $(gpio -g read 18) -eq 1 ]
                then
                        gpio -g write 18 0
                fi
		Water $period
        fi
        
}

Water()
	{
	sensors=$ReadSensor
	Now=$(date +"%F %T")
	gw='gpio -g write'
	gr='gpio -g read'
	sql='mysql -upi -pa-51d41e Farm -N'
	Lr=$(if [[ $(gpio -g read 18) -eq "1" ]]; then  echo "Lights On"; else  echo "Lights Off"; fi)
	Pr=$(if [[ $(gpio -g read 15) -eq "1" ]]; then  echo "Water Pump On"; else  echo "Water Pump Off"; fi)
        Pw=$gw" 15"
	Poff=$Pw" 0"
	Pon=$Pw" 1"
        Fsched=$(echo "select * from farmSched order by date desc limit 1;" | mysql -upi -pa-51d41e Farm -N)
	if [[ -z $NextFlood ]]
	then
	        LastFlood=$(echo $Fsched | awk -F " " '{print $3 " " $4}')
	        NextFlood=$(echo $Fsched | awk -F " " '{print $5 " " $6}')
	fi
	period=$1
	FloodTime='5'
	if [[ $Now > $NextFlood ]]
	then
		in4=$(date +%T -d "+"$FloodTime"minutes")
		LastFlood=$(date +"%F %T")
		while [[ $(date +%T) < $in4 ]]
		do
			gpio -g write 15 1
			ShellScreen
		done
		gpio -g write 15 0
		NextFlood=$(date "+%F %T" --date='+'$period' minutes')
                LastpHCal=$(echo $Fsched | awk -F " " '{print $8 " " $9}')
                NextpHCal=$(echo $Fsched | awk -F " " '{print $10 " " $11}')
		Vol=$(echo $Fsched | awk -F " " '{print $12}')
                line=$(echo "'"$(date +"%F %T")"','"$LastFlood"','"$NextFlood"','"$period"','"$LastpHCal"','"$NextpHCal"','"$Vol"'")
# 		echo "line: " $line
		echo "\INSERT INTO farmSched (date,LastFlood,NextFlood,period,LastpHCal,NextpHCal,Vol) VALUES ("$line ");" | mysql -upi -pa-51d41e Farm -N
		echo "select * from farmSched order by date desc limit 2;" | mysql -upi -pa-51d41e Farm -N
	else
		ShellScreen
	fi 
	}


Aerate()
        {
        ####################################
        #                                  #
        #   air pump on/off even minutes   #
        #                                  #
        ####################################
        min=$(date +%M)
        if [ $((10#${min}%2)) -eq 0 ]
        then
                gpio -g write 14 1
        else
                gpio -g write 14 0
        fi

        #########################
        #                       #
        # rurn the exhaust fan  #
        #   3 min every hour    #
        #########################
        AirOut="56"
        ExFanStat=$(gpio -g read 8)
        if [[ $Tsens1 > 28.3 ]]
        then
                gpio -g write 8 1

        elif [[ $ExFanStat = 1 ]] && [[ $RoomTemp < 28.5 ]]
        then
                gpio -g write 8 0
        fi

}




        ##########################
        #                        #
        #  shell status display  #
        #                        #
        ##########################
ShellScreen()
        {
        if [ -z $pH ] && [ -z $EV ]
        then
                pH=$(echo "select pH from H2O ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N)
                EC=$(echo "select EV from H2O ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N)     
                TDS=$(echo "select TDS from H2O ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N)
                Salt=$(echo "select Salt from H2O ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N)
                SG=$(echo "select SG from H2O ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N)
                Tsens2=$(echo "select Temp from H2O ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N)
                Tsens1=$(echo "select LampTemp from farmdata ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N)
                Tsens3=$(echo "select SoilTemp from farmdata ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N)
                Level=$(echo "select Level from farmdata ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N)
        fi
        AirStatus=$(gpio -g read 14)
        PumpStatus=$(gpio -g read 15)
        LigthStatus=$(gpio -g read 18)
        Drain=$(/var/www/hall.py )
        ExhaustFan=$(gpio -g read 8)
        if [ $AirStatus -eq "0" ]
        then
                AirStatusTxt="Off"
        elif [ $AirStatus -eq "1"  ]
        then
                AirStatusTxt="On  "
        fi

        if [ $PumpStatus -eq "0" ]
        then
                PumpStatusTxt="Off"
        elif [ $PumpStatus -eq "1"  ]
        then
                PumpStatusTxt="On  "
        fi

        if [ $LigthStatus -eq "0" ]
        then
                LigthStatusTxt="Off"
        elif [ $LigthStatus -eq "1"  ]
        then
                LigthStatusTxt="On "
        fi
        if [ $Drain -eq "0" ]
        then
                Drain="Off"
       else
                Drain="On "
        fi
        if [ $ExhaustFan -eq "0" ]
        then
                ExFan="Off"
       else
                 ExFan="On "
        fi
        line=$(echo "'"$(date +%F-%H:%M:%S)"','"$LigthStatusTxt"','"$ExFan"','"$AirStatusTxt"','"$PumpStatusTxt"','"$Drain"','"$Level"','"$Mode"','"$Tsens2"','"$Tsens1"'")
       echo "INSERT INTO farmdata (date,lights,ExFan,AirPump,WaterPump,Drain,Level,mode,LampTemp,SoilTemp) VALUES ("$line ");" | mysql -upi -pa-51d41e Farm -N
        echo "COMMIT;" | mysql -upi -pa-51d41e Farm -N
        Level=$(echo "SELECT Level FROM farmdata ORDER BY date DESC LIMIT 1;" | mysql -upi -pa-51d41e Farm -N )

        echo -e ' \t ' > ./ScreenFile
        echo  -e "GrowBot6" >> ./ScreenFile
        date +"%D %T" >> ./ScreenFile
        echo  -e "An Evil Scientist SINdicate production" >> ./ScreenFile
        echo  -e "" >> ./ScreenFile
        echo  -e "Mode:" $Mode "\t LightOn:"$LightOn":00    LightOff: "$LightOff":00" >> ./ScreenFile
        echo  -e "Light Status       :\t" $LigthStatusTxt >> ./ScreenFile
        echo  -e "Exhaust Fan status :\t" $ExFan >> ./ScreenFile
        echo  -e "AirPump Status     :\t" $AirStatusTxt >> ./ScreenFile
        echo  -e "Pump Status        :\t" $PumpStatusTxt "\t Period: " $period" Min"  >> ./ScreenFile #$(gpio -g read 17)/$(gpio -g read 27) "En/Bed" >> ./ScreenFile
        echo  -e "Drain              :\t" $Drain "\t Last flood: " $LastFlood >> ./ScreenFile
        echo  -e "\t\t\t\t Next flood: " $NextFlood >> ./ScreenFile
        echo  -e "\t\t\t\t level: " $Level >> ./ScreenFile
        echo  -e "" >> ./ScreenFile
        echo  -e "pH              : " $pH "\t Delta" $(echo "scale=3; "$pH "- 5.8" | bc | sed -r 's/^(-?)\./\10./') "[5.6/5.8/6.0]" >> ./ScreenFile
        echo  -e "Conductivity    : " $EC >> ./ScreenFile
        echo  -e "TDS             : " $TDS >> ./ScreenFile
        echo  -e "Salinity        : " $Salt >> ./ScreenFile
        echo  -e "Specific Gravity: " $SG >> ./ScreenFile
        echo  -e "" >> ./ScreenFile
        echo  -e "Temp Lamp       : " $Tsens2 >> ./ScreenFile
        echo  -e "Temp Mid Room   : " $Tsens1 >> ./ScreenFile
        echo  -e "Temp Tank       : " $Tsens3 >> ./ScreenFile
        echo  -e "" >> ./ScreenFile
        echo  -e "select date, mode, lights, ExFan, AirPump, WaterPump, Drain, Level, LampTemp, SoilTemp from farmdata ORDER BY date DESC LIMIT 7 " | mysql -upi -pa-51d41e -t Farm >> ./ScreenFile
        echo  -e "select * from farmSched ORDER BY date DESC LIMIT 7 " | mysql -upi -pa-51d41e -t Farm >> ./ScreenFile
        echo  -e "select * from H2O order by date desc limit 7;" | mysql -t -upi -pa-51d41e Farm >> ./ScreenFile
#       "\t\t\t"
        sed -e 's/^/                              /' ./Screen2File >> ./ScreenFile && rm -f ./Screen2File
        clear
        cat ./ScreenFile
	}












while true 
do
	if [[ -z $(sudo ps -A | grep "readsensor.sh") ]]
        then
                /usr/bin/screen  -dm -S ReadSensors ./readsensor.sh $Mode 
        fi
	if [[ -z $(service grafana-server status | grep -c "Active: active") ]]
	then
		service grafana-server start
	fi
	ShellScreen
	Lights $LightOn $LightOff $period
	Aerate
done
